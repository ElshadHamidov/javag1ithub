<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart - E-commerce</title>
  <link rel="stylesheet" href="cart.css" />
  <script src="https://kit.fontawesome.com/8b8c0b08e2.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
</head>

<body>
  <div class="top-banner">
    Summer Sale! 50% Off All Items & Free Express Delivery - OFF 50% <a href="#">ShopNow</a>
  </div>

  <header>
    <div class="logo">E-commerce</div>
    <nav>
      <a href="./index.html">Home</a>
      <a href="./contact.html">Contact</a>
      <a href="./about.html">About</a>
      <a href="./signup.html">Sign Up</a>
      <a href="./shop.html" class="shop-btn">Shop</a>
    </nav>
    <div class="header-right">
      <input type="text" placeholder="What are you looking for?" class="search-box" />
      <button class="login-btn">Log In</button>
    </div>
  </header>

  <div class="cart-container">
    <table id="cart-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="cart-summary">
      <h3>Cart Total</h3>
      <p><span>Subtotal</span><span id="subtotal-value">0.00</span></p>
      <p><span>Shipping</span><span>Free</span></p>
      <p><strong>Total</strong><strong id="total-value">0.00</strong></p>
      <a href="./checkout.html" class="checkout-btn">Proceed to checkout</a>
    </div>
  </div>

  <footer>
    <div class="footer-container">
      <div class="footer-section">
        <h3>Exclusive</h3>
        <p>Get 10% off your first order</p>
        <div class="subscribe">
          <input type="email" placeholder="Enter your email" /><br /><br />
          <button>Subscribe</button>
        </div>
      </div>
      <div class="footer-section">
        <h3>Support</h3>
        <p>111 Bijoy sarani, Dhaka, DH 1515, Bangladesh</p>
        <p>ecommerce@gmail.com</p>
        <p>+88015-88888-9999</p>
      </div>
      <div class="footer-section">
        <h3>Account</h3>
        <a href="./profile.html">My Account</a>
        <a href="./signup.html">Login / Register</a>
        <a href="./cart.html">Cart</a>
        <a href="./order.html">My Order</a>
        <a href="./products.html">My Products</a>
      </div>
      <div class="footer-section">
        <h3>Quick Link</h3>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms Of Use</a>
        <a href="#">FAQ</a>
        <a href="#">Contact</a>
      </div>
      <div class="footer-section">
        <h3>Download App</h3>
        <img src="https://th.bing.com/th/id/OIP.VfrGvim12lMo8DRnHOCTlwHaHU?w=188&h=186&c=7&r=0&o=7&pid=1.7&rm=3"
          alt="App QR" />
        <div class="social-icons">
          <a href="#"><i class="fa-brands fa-facebook"></i></a>
          <a href="#"><i class="fa-brands fa-x-twitter"></i></a>
          <a href="#"><i class="fa-brands fa-instagram"></i></a>
          <a href="#"><i class="fa-brands fa-linkedin"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">¬© Copyright Remi 2025. All rights reserved.</div>
  </footer>

  <script>
    const CART_API = "http://localhost:8086/api/cart";
    let cartItems = [];

    document.addEventListener("DOMContentLoaded", loadCart);

    async function loadCart() {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${CART_API}/getCart`, {
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
        });

        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const data = await res.json();
        console.log("üßæ Cart response:", data);

        cartItems = Array.isArray(data) ? data : [];
        renderCart();
      } catch (err) {
        console.error("‚ùå Error loading cart:", err);
        alert("‚ö†Ô∏è Failed to load cart data from server.");
      }
    }

    function renderCart() {
      const tbody = document.querySelector("#cart-table tbody");
      tbody.innerHTML = "";

      if (cartItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">üõí Your cart is empty.</td></tr>`;
        updateTotals();
        return;
      }

      cartItems.forEach((item, index) => {
        // If product is nested inside the item
        const product = item.product || item;

        tbody.innerHTML += `
      <tr>
        <td><img src="${product.image}" width="80"> ${product.name || item.product_name}</td>
        <td class="price">${(product.price || item.price).toFixed(2)}</td>
        <td>
          <input type="number"
                 class="quantity"
                 value="${item.quantity}"
                 min="1"
                 data-index="${index}"
                 style="width:50px;">
        </td>
        <td class="subtotal">${((product.price || item.price) * item.quantity).toFixed(2)}</td>
        <td><button class="remove-btn" data-index="${index}">üóëÔ∏è Remove</button></td>
      </tr>`;
      });

      document.querySelectorAll(".quantity").forEach(input =>
        input.addEventListener("change", updateQuantity)
      );
      document.querySelectorAll(".remove-btn").forEach(btn =>
        btn.addEventListener("click", removeItem)
      );

      updateTotals();
    }

    function updateTotals() {
      const subtotal = cartItems.reduce((sum, item) => {
        const product = item.product || item; // fallback
        const price = Number(product.price || item.price || 0);
        const quantity = Number(item.quantity || 1);
        return sum + price * quantity;
      }, 0);

      const subtotalEl = document.getElementById("subtotal-value");
      const totalEl = document.getElementById("total-value");

      if (subtotalEl) subtotalEl.textContent = subtotal.toFixed(2);
      if (totalEl) totalEl.textContent = subtotal.toFixed(2);

      localStorage.setItem("cartTotal", subtotal.toFixed(2));
    }



    function handleCartEvent(e) {
      if (e.target.classList.contains("quantity")) updateQuantity(e);
      if (e.target.classList.contains("remove-btn")) removeItem(e);
    }

    async function updateQuantity(e) {
      const index = e.target.dataset.index;
      const newQty = parseInt(e.target.value);
      const item = cartItems[index];

      if (!item || isNaN(newQty) || newQty < 1) return;

      item.quantity = newQty;
      document.querySelectorAll(".subtotal")[index].textContent = (item.price * newQty).toFixed(2);
      updateTotals();

      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${CART_API}/update`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({
            id: item.id,
            productId: item.productId,
            quantity: newQty,
          }),
        });

        if (!res.ok) throw new Error(`Failed to update item ID ${item.id}`);
      } catch (err) {
        console.error("‚ùå Error updating quantity:", err);
        alert("‚ö†Ô∏è Failed to update item quantity.");
      }
    }

    async function removeItem(e) {
      const index = e.target.dataset.index;
      const item = cartItems[index];
      if (!item) return;

      if (!confirm(`Remove ${item.productName} from your cart?`)) return;

      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${CART_API}/delete/${item.id}`, {
          method: "DELETE",
          headers: {
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
        });

        if (!res.ok) throw new Error(`Failed to delete item ID ${item.id}`);
        cartItems.splice(index, 1);
        renderCart();
      } catch (err) {
        console.error("‚ùå Error deleting item:", err);
        alert("‚ö†Ô∏è Failed to remove item from server.");
      }
    }

    async function addToCart(productId, quantity = 1) {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${CART_API}/add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify({ productId, quantity }),
        });

        if (!res.ok) throw new Error("Add to cart failed");
        alert("‚úÖ Product added to cart successfully!");
        await loadCart();
      } catch (err) {
        console.error("‚ùå Error adding to cart:", err);
        alert("‚ö†Ô∏è Failed to add product to cart.");
      }
    }
    async function loadCart() {
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`${CART_API}/getCart`, {
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
        });

        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const data = await res.json();
        console.log("üßæ Cart response:", data);
        cartItems = Array.isArray(data) ? data : Array.isArray(data.cart) ? data.cart : [];
        renderCart();
      } catch (err) {
        console.error("‚ùå Error loading cart:", err);
        alert("‚ö†Ô∏è Failed to load cart data from server.");
      }
    }

  </script>
</body>

</html>